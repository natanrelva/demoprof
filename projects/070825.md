## 🧩 1. Estrutura Geral (visão simplificada)

O sistema pode ser visto como 3 grandes blocos independentes:

```
[CANAIS] → [AGENTE IA + GRAFO] → [NÚCLEO DE COMÉRCIO]
```

* **\[CANAIS]** = WhatsApp, Telegram, etc. Só enviam/recebem mensagens.
* **\[AGENTE IA + GRAFO]** = Interpreta a mensagem e decide o que fazer.
* **\[NÚCLEO DE COMÉRCIO]** = Cria pedido, cobra, responde, registra.

---

## 🎛️ 2. Blocos Funcionais Resumidos

| Nome do Bloco          | Função Principal                 | Simplificação                                                   |
| ---------------------- | -------------------------------- | --------------------------------------------------------------- |
| **Canal**              | Envia/recebe mensagem do usuário | WhatsApp, Telegram, etc. São só ponte de entrada/saída.         |
| **Agente IA**          | Entende intenção da mensagem     | Usa regras ou IA para saber o que o usuário quer.               |
| **Grafo de Navegação** | Define os caminhos da conversa   | Uma sequência de perguntas e respostas como um fluxograma.      |
| **Executor de Ação**   | Faz o que foi pedido             | Ex: criar pedido, mostrar produto, iniciar pagamento.           |
| **Pedido**             | Representa a compra em si        | Contém produto, valor, canal e status (criado, pago, etc.)      |
| **Pagamento**          | Lida com o pagamento             | Gera link, espera confirmação e muda status.                    |
| **Antifraude**         | Detecta comportamento suspeito   | Verifica riscos antes de confirmar ações sensíveis.             |
| **Adaptadores**        | Conectam partes externas         | Transforma pedidos da lógica interna em chamadas reais de APIs. |
| **Logger / Estado**    | Guarda histórico do usuário      | Para que o fluxo continue de onde parou.                        |

---

## 🛠️ 3. Funcionalidades mínimas e claras

Cada funcionalidade abaixo pode ser isolada, documentada e implementada sem depender de todo o sistema estar pronto:

| ID    | Nome                | Explicação simplificada                                |
| ----- | ------------------- | ------------------------------------------------------ |
| `M01` | Entender mensagem   | Detectar se o usuário quer comprar, pagar, cancelar... |
| `M02` | Escolher produto    | Mostrar opções e deixar o usuário escolher.            |
| `M03` | Criar pedido        | Gerar um pedido com produto e canal.                   |
| `M04` | Iniciar pagamento   | Gerar link e enviar para o usuário pagar.              |
| `M05` | Confirmar pagamento | Marcar como “pago” e avisar o usuário.                 |
| `M06` | Ver histórico       | Mostrar pedidos anteriores do mesmo usuário.           |
| `M07` | Validar fraude      | Bloquear ações suspeitas.                              |
| `M08` | Voltar onde parou   | Continuar a conversa se o usuário cair e voltar.       |
| `M09` | Testar por canal    | Simular fluxo para WhatsApp e Telegram.                |

---

## 🔄 4. Fluxo de Compra (via canal)

1. Usuário manda mensagem no canal (WhatsApp/Telegram)
2. Agente entende a intenção (ex: “quero comprar”)
3. O grafo responde perguntando o produto
4. Usuário escolhe
5. Sistema cria pedido
6. Gera link de pagamento específico do canal
7. Espera confirmação do pagamento
8. Marca como pago e envia mensagem de sucesso

---

## 🔌 5. Adapters e Interfaces (camada de conexão)

| Nome               | Simplificação                                     |
| ------------------ | ------------------------------------------------- |
| Canal Adapter      | Recebe texto e envia texto. Nada mais.            |
| Pagamento Adapter  | Recebe valor e retorna link. Espera webhook.      |
| Grafo Adapter      | Recebe entrada, retorna próxima pergunta ou ação. |
| Antifraude Adapter | Recebe dados, responde “pode ou não pode”.        |

---

## 🔐 6. Segurança / Antifraude

* Toda ação pode ser avaliada antes de ser executada.
* Exemplo: bloqueia se houver muitas compras em pouco tempo.
* Resultados simples: **"pode seguir" ou "bloquear"**.

---

## 🧪 7. Testes (por tipo)

| Tipo           | O que testa                                           |
| -------------- | ----------------------------------------------------- |
| **Unitário**   | Cada parte sozinha: grafo, parser, adaptador de canal |
| **Integração** | Conexões reais entre canal → grafo → backend          |
| **Funcional**  | Um fluxo completo de compra simulada                  |
| **Segurança**  | Testa se o antifraude bloqueia como esperado          |

---

## 📦 8. MVP Absolutamente Mínimo

Para validar tudo:

* Canal: WhatsApp (mockado ou real via Cloud API)
* Agente: IA simples com 2-3 intenções
* Grafo: fluxo com 3 nós (boas-vindas → escolha → pagamento)
* Backend: cria pedido em memória
* Pagamento: gera link simulado
* Confirmação: mensagem de sucesso pós-pagamento
* Antifraude: regra simples (1 pedido por minuto)

---

## 🗂️ 9. Organização por Pastas (projeto limpo)

```
/agents/         → agentes IA por canal
/adapters/       → integrações externas (canal, pagamento)
/core/           → domínio: pedido, pagamento, antifraude
/graph/          → fluxos e transições
/interfaces/     → portas (Ports)
/usecases/       → lógica de aplicação (Interactors)
/tests/          → testes unitários e e2e
```
